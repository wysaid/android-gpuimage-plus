name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Official release tags (e.g., v3.1.1)

jobs:
  validate-and-release:
    name: Validate Version and Build Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup NDK
      uses: nttld/setup-ndk@v1.4.2
      id: setup-ndk
      with:
        ndk-version: r26d
        link-to-sdk: true
        add-to-path: true
    
    - name: Install Ninja
      run: sudo apt-get update && sudo apt-get install -y ninja-build
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for scripts
      run: chmod +x gradlew tasks.sh publish.sh
    
    - name: Extract tag version
      id: tag_version
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        
        # Extract version numbers (e.g., v3.1.1 -> 3.1.1)
        if [[ $TAG_NAME =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
          VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Valid version tag: $TAG_NAME (version: $VERSION)"
        else
          echo "âŒ Invalid tag format: $TAG_NAME"
          echo "Tag must be in format: v\${major}.\${minor}.\${patch} (e.g., v3.1.1)"
          exit 1
        fi
    
    - name: Validate version matches project version
      run: |
        PROJECT_VERSION=$(grep -E 'versionName\s*:' build.gradle | sed -E 's/.*versionName\s*:\s*"([^"]+)".*/\1/')
        TAG_VERSION="${{ steps.tag_version.outputs.version }}"
        
        echo "Project version: $PROJECT_VERSION"
        echo "Tag version: $TAG_VERSION"
        
        if [ "$PROJECT_VERSION" != "$TAG_VERSION" ]; then
          echo "âŒ Version mismatch!"
          echo "Tag version ($TAG_VERSION) does not match project version ($PROJECT_VERSION)"
          echo "Please update the versionName in build.gradle to match the tag, or use the correct tag."
          exit 1
        fi
        
        echo "âœ… Version validation passed: $TAG_VERSION"
    
    - name: Setup local.properties for publishing
      run: |
        # Create local.properties with necessary configurations
        mkdir -p /tmp/maven-repo
        cat > local.properties << EOF
        usingCMakeCompile=true
        usingCMakeCompileDebug=false
        deployArtifacts=true
        localRepoDir=/tmp/maven-repo
        EOF
        
        echo "âœ… local.properties configured for publishing"
        cat local.properties
    
    - name: Build all artifact variants
      run: |
        echo "ðŸ”¨ Building all 4 artifact variants..."
        bash -e ./publish.sh
        
        echo "âœ… All artifacts built successfully"
        echo "ðŸ“¦ Generated artifacts:"
        find /tmp/maven-repo -type f -name "*.aar" -o -name "*.pom" | sort
    
    - name: Build demo APK with video module
      run: |
        echo "ðŸ”¨ Building demo APK with video module (default configuration)..."
        ./tasks.sh --enable-cmake --release --enable-video-module --build
        
        # Find and copy the APK
        APK_PATH=$(find "cgeDemo/build" -name "*.apk" | grep -i release | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "âŒ APK not found!"
          exit 1
        fi
        
        mkdir -p /tmp/release-artifacts
        cp "$APK_PATH" /tmp/release-artifacts/cgeDemo-${{ steps.tag_version.outputs.version }}.apk
        
        echo "âœ… Demo APK built successfully"
        ls -lh /tmp/release-artifacts/
    
    - name: Package AAR artifacts
      run: |
        echo "ðŸ“¦ Packaging AAR artifacts..."
        
        VERSION="${{ steps.tag_version.outputs.version }}"
        MAVEN_REPO="/tmp/maven-repo"
        ARTIFACTS_DIR="/tmp/release-artifacts"
        
        # Find and copy all AAR files from the maven repository
        # Expected structure: /tmp/maven-repo/org/wysaid/gpuimage-plus/{version}/gpuimage-plus-{version}.aar
        find "$MAVEN_REPO/org/wysaid/gpuimage-plus" -name "*.aar" | while read aar_file; do
          filename=$(basename "$aar_file")
          cp "$aar_file" "$ARTIFACTS_DIR/$filename"
          echo "  âœ“ Packaged: $filename"
        done
        
        echo "âœ… All AAR artifacts packaged"
        echo "ðŸ“¦ Final artifacts:"
        ls -lh "$ARTIFACTS_DIR/"
    
    - name: Generate release notes
      id: release_notes
      run: |
        cat > /tmp/release_notes.md << 'EOF'
        ## ðŸš€ Android GPUImage Plus ${{ steps.tag_version.outputs.tag_name }}
        
        ### ðŸ“¦ Downloads
        
        **Demo APK:**
        - `cgeDemo-${{ steps.tag_version.outputs.version }}.apk` - Demo application with full video features
        
        **AAR Library Artifacts:**
        
        Four variants are available for different use cases:
        
        1. **gpuimage-plus-${{ steps.tag_version.outputs.version }}.aar**
           - Page size: 4KB (default)
           - Full-featured with FFmpeg bundled
           - Architectures: armeabi-v7a, arm64-v8a, x86, x86_64
        
        2. **gpuimage-plus-${{ steps.tag_version.outputs.version }}-16k.aar**
           - Page size: 16KB
           - Full-featured with FFmpeg bundled
           - Architectures: armeabi-v7a, arm64-v8a, x86, x86_64
        
        3. **gpuimage-plus-${{ steps.tag_version.outputs.version }}-min.aar**
           - Page size: 4KB (default)
           - Image-only version (no video features or FFmpeg)
           - Architectures: armeabi-v7a, arm64-v8a, x86, x86_64
        
        4. **gpuimage-plus-${{ steps.tag_version.outputs.version }}-16k-min.aar**
           - Page size: 16KB
           - Image-only version (no video features or FFmpeg)
           - Architectures: armeabi-v7a, arm64-v8a, x86, x86_64
        
        ### ðŸ”§ Gradle Dependency
        
        ```gradle
        allprojects {
            repositories {
                maven {
                    url 'https://maven.wysaid.org/'
                }
            }
        }
        
        dependencies {
            // Choose one of the following based on your needs:
            
            // Full-featured with FFmpeg (4KB page size)
            implementation 'org.wysaid:gpuimage-plus:${{ steps.tag_version.outputs.version }}'
            
            // Full-featured with FFmpeg (16KB page size)
            implementation 'org.wysaid:gpuimage-plus:${{ steps.tag_version.outputs.version }}-16k'
            
            // Image-only, no video (4KB page size)
            implementation 'org.wysaid:gpuimage-plus:${{ steps.tag_version.outputs.version }}-min'
            
            // Image-only, no video (16KB page size)
            implementation 'org.wysaid:gpuimage-plus:${{ steps.tag_version.outputs.version }}-16k-min'
        }
        ```
        
        ### ðŸ“‹ System Requirements
        
        - **Minimum Android SDK**: API 21 (Android 5.0)
        - **Target Android SDK**: API 25
        - **NDK Version**: r26d
        - **Supported Architectures**: armeabi-v7a, arm64-v8a, x86, x86_64
        
        ### ðŸ“š Documentation
        
        - **GitHub Repository**: https://github.com/wysaid/android-gpuimage-plus
        - **Wiki**: https://github.com/wysaid/android-gpuimage-plus/wiki
        - **Filter Rule Documentation**: https://github.com/wysaid/android-gpuimage-plus/wiki/Parsing-String-Rule-(EN)
        
        ---
        
        For complete changelog, see the auto-generated content below.
        EOF
        
        echo "âœ… Release notes generated"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag_version.outputs.tag_name }}
        name: Release ${{ steps.tag_version.outputs.tag_name }}
        body_path: /tmp/release_notes.md
        files: |
          /tmp/release-artifacts/*.apk
          /tmp/release-artifacts/*.aar
        draft: false
        prerelease: false
        generate_release_notes: true
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Summary
      run: |
        echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release**: ${{ steps.tag_version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ steps.tag_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Version Validation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Tag format validated: v\${major}.\${minor}.\${patch}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Version matches project version in build.gradle" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Released Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "**Demo APK:**" >> $GITHUB_STEP_SUMMARY
        echo "- cgeDemo-${{ steps.tag_version.outputs.version }}.apk" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**AAR Libraries:**" >> $GITHUB_STEP_SUMMARY
        echo "- gpuimage-plus-${{ steps.tag_version.outputs.version }}.aar (4KB, with video)" >> $GITHUB_STEP_SUMMARY
        echo "- gpuimage-plus-${{ steps.tag_version.outputs.version }}-16k.aar (16KB, with video)" >> $GITHUB_STEP_SUMMARY
        echo "- gpuimage-plus-${{ steps.tag_version.outputs.version }}-min.aar (4KB, image-only)" >> $GITHUB_STEP_SUMMARY
        echo "- gpuimage-plus-${{ steps.tag_version.outputs.version }}-16k-min.aar (16KB, image-only)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Release page: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.tag_version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
