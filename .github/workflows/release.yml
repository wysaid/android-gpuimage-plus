name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'         # Official release tags (e.g., v3.1.1)
      - 'v*.*.*-beta*'   # Beta releases (e.g., v3.1.1-beta1)
      - 'v*.*.*-alpha*'  # Alpha releases (e.g., v3.1.1-alpha1)
      - 'v*.*.*-rc*'     # Release candidates (e.g., v3.1.1-rc1)
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 3.1.1 or 3.1.1-beta1, without leading v) - Manual trigger will NOT publish to Release page'
        required: true
        type: string

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate-and-release:
    name: Validate Version and Build Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for creating releases and uploading artifacts
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup NDK
      uses: nttld/setup-ndk@v1.4.2
      id: setup-ndk
      with:
        ndk-version: r26d
        link-to-sdk: true
        add-to-path: true
    
    - name: Install build tools
      run: sudo apt-get update && sudo apt-get install -y ninja-build jq rsync
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Cache NDK and CMake builds
      uses: actions/cache@v4
      with:
        path: |
          ~/.android/build-cache
          library/.cxx
          library/build
        key: ${{ runner.os }}-ndk-${{ hashFiles('**/*.gradle*', '**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-ndk-
    
    - name: Grant execute permission for scripts
      run: chmod +x gradlew tasks.sh publish.sh
    
    - name: Extract tag version
      id: tag_version
      env:
        EVENT_NAME: ${{ github.event_name }}
        INPUT_VERSION: ${{ github.event.inputs.version }}
      run: |
        # Determine if this is a manual trigger or tag push
        if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
          # Manual trigger - sanitize and normalize input version
          RAW_VERSION="$INPUT_VERSION"
          RAW_VERSION="${RAW_VERSION#${RAW_VERSION%%[![:space:]]*}}"
          RAW_VERSION="${RAW_VERSION%${RAW_VERSION##*[![:space:]]}}"

          if [ -z "$RAW_VERSION" ]; then
            echo "âŒ Version input cannot be empty"
            exit 1
          fi

          VERSION="${RAW_VERSION#v}"
          if [ "$VERSION" != "$RAW_VERSION" ]; then
            echo "âš ï¸ Input starts with 'v'; auto-stripped to '$VERSION'"
          fi

          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?$ ]]; then
            echo "âŒ Invalid version input: $RAW_VERSION"
            echo "Expected format: {major}.{minor}.{patch}[-prerelease], e.g., 3.1.1 or 3.1.1-beta1"
            exit 1
          fi

          TAG_NAME="v$VERSION"
          IS_MANUAL="true"
          echo "ðŸ”§ Manual trigger detected"
        else
          # Tag push - extract from ref
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          IS_MANUAL="false"
        fi

        # Extract and validate version numbers supporting prerelease tags
        # e.g., v3.1.1-beta1 -> base=3.1.1, version=3.1.1-beta1
        if [[ $TAG_NAME =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)(-[a-zA-Z0-9\.]+)?$ ]]; then
          BASE_VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
          PRERELEASE_SUFFIX="${BASH_REMATCH[4]}"
          VERSION="${BASE_VERSION}${PRERELEASE_SUFFIX}"

          if [ -n "$PRERELEASE_SUFFIX" ]; then
            IS_PRERELEASE="true"
            echo "ðŸ§ª Prerelease detected: $PRERELEASE_SUFFIX"
          else
            IS_PRERELEASE="false"
          fi
        else
          echo "âŒ Invalid tag format: $TAG_NAME"
          echo "Tag must be: v{major}.{minor}.{patch}[-prerelease] (e.g., v3.1.1 or v3.1.1-beta1)"
          exit 1
        fi
        
        # Validate base version format
        if [[ ! $BASE_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Invalid base version format: $BASE_VERSION"
          echo "Version must be in format: \${major}.\${minor}.\${patch} (e.g., 3.1.1)"
          exit 1
        fi
        
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
        echo "is_manual=$IS_MANUAL" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "âœ… Valid version: $VERSION (tag: $TAG_NAME, prerelease: $IS_PRERELEASE, manual: $IS_MANUAL)"
    
    - name: Validate version matches project version
      run: |
        PROJECT_VERSION=$(grep -E 'versionName\s*:' build.gradle | sed -E 's/.*versionName\s*:\s*"([^"]+)".*/\1/')
        TAG_VERSION="${{ steps.tag_version.outputs.version }}"
        
        echo "Project version: $PROJECT_VERSION"
        echo "Tag full version: $TAG_VERSION"
        
        # Tag version must exactly match versionName in build.gradle
        if [ "$PROJECT_VERSION" != "$TAG_VERSION" ]; then
          echo "âŒ Version mismatch!"
          echo "Tag version ($TAG_VERSION) does not match project version ($PROJECT_VERSION)"
          echo "Please update the versionName in build.gradle to match the tag, or use the correct tag."
          exit 1
        fi
        
        echo "âœ… Version validation passed: $TAG_VERSION"
    
    - name: Setup local.properties for publishing
      run: |
        # Create local.properties with necessary configurations
        mkdir -p /tmp/maven-repo
        cat > local.properties << EOF
        usingCMakeCompile=true
        usingCMakeCompileDebug=false
        deployArtifacts=true
        localRepoDir=/tmp/maven-repo
        EOF
        
        echo "âœ… local.properties configured for publishing"
        cat local.properties
    
    - name: Build all artifact variants
      id: build_variants
      run: |
        BUILD_START=$(date +%s)
        echo "ðŸ”¨ Building all 4 artifact variants..."
        bash -e ./publish.sh
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo "âœ… All artifacts built successfully"
        echo "â±ï¸  Build time: $((BUILD_TIME / 60)) minutes $((BUILD_TIME % 60)) seconds"
        echo "ðŸ“¦ Generated artifacts:"
        find /tmp/maven-repo -type f \( -name "*.aar" -o -name "*.pom" \) | sort
        
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
    
    - name: Build demo APK with video module
      run: |
        echo "ðŸ”¨ Building demo APK with video module (default configuration)..."
        ./tasks.sh --enable-cmake --release --enable-video-module --disable-16kb-page-size --build
        
        # Find and copy the APK (look specifically for release build output)
        APK_PATH=$(find "cgeDemo/build/outputs/apk/release" \( -name "*-release.apk" -o -name "*-release-unsigned.apk" \) | head -1)
        if [ -z "$APK_PATH" ]; then
          # Fallback: search in build directory
          APK_PATH=$(find "cgeDemo/build" -path "*/release/*" -name "*.apk" | head -1)
        fi
        if [ -z "$APK_PATH" ]; then
          echo "âŒ APK not found!"
          echo "Searched locations:"
          find "cgeDemo/build" -name "*.apk" || echo "No APK files found"
          exit 1
        fi
        
        mkdir -p /tmp/release-artifacts
        cp "$APK_PATH" /tmp/release-artifacts/cgeDemo-${{ steps.tag_version.outputs.version }}.apk
        
        echo "âœ… Demo APK built successfully"
        ls -lh /tmp/release-artifacts/
    
    - name: Validate APK size and properties
      run: |
        echo "ðŸ” Checking APK size and basic properties..."
        APK_FILE=$(ls /tmp/release-artifacts/*.apk | head -1)
        APK_SIZE=$(stat -c%s "$APK_FILE" 2>/dev/null || stat -f%z "$APK_FILE")
        APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
        
        echo "ðŸ“¦ APK size: ${APK_SIZE_MB} MB"
        
        # Warn if APK is unusually large
        if [ $APK_SIZE -gt 104857600 ]; then  # 100MB
          echo "::warning::APK size (${APK_SIZE_MB} MB) exceeds 100MB, consider optimization"
        fi
        
        # Warn if APK is unusually small (might indicate build issue)
        if [ $APK_SIZE -lt 5242880 ]; then  # 5MB
          echo "::warning::APK size (${APK_SIZE_MB} MB) is unusually small, please verify"
        fi
        
        echo "âœ… APK validation passed"
    
    - name: Package AAR artifacts
      run: |
        echo "ðŸ“¦ Packaging AAR artifacts..."
        
        VERSION="${{ steps.tag_version.outputs.version }}"
        MAVEN_REPO="/tmp/maven-repo"
        ARTIFACTS_DIR="/tmp/release-artifacts"
        
        # Find and copy all AAR files from the maven repository
        # Expected structure: /tmp/maven-repo/org/wysaid/gpuimage-plus/{version}/gpuimage-plus-{version}.aar
        while IFS= read -r aar_file; do
          if [ -n "$aar_file" ]; then
            filename=$(basename "$aar_file")
            cp "$aar_file" "$ARTIFACTS_DIR/$filename"
            echo "  âœ“ Packaged: $filename"
          fi
        done < <(find "$MAVEN_REPO/org/wysaid/gpuimage-plus" -name "*.aar")
        
        # Validate that we have exactly 4 AAR files
        AAR_COUNT=$(find "$ARTIFACTS_DIR" -name "*.aar" | wc -l)
        if [ "$AAR_COUNT" -ne 4 ]; then
          echo "âŒ Expected 4 AAR files but found $AAR_COUNT"
          exit 1
        fi
        
        echo "âœ… All AAR artifacts packaged ($AAR_COUNT files)"
        echo "ðŸ“¦ Final artifacts:"
        ls -lh "$ARTIFACTS_DIR/"
    
    - name: Generate artifact checksums
      run: |
        echo "ðŸ” Generating SHA256 checksums for all artifacts..."
        cd /tmp/release-artifacts
        
        # Generate checksums for all files
        sha256sum *.apk *.aar > SHA256SUMS.txt 2>/dev/null || shasum -a 256 *.apk *.aar > SHA256SUMS.txt
        
        echo "âœ… Checksums generated:"
        cat SHA256SUMS.txt
        
        # Also create individual checksum files for convenience
        for file in *.apk *.aar; do
          if [ -f "$file" ]; then
            sha256sum "$file" > "${file}.sha256" 2>/dev/null || shasum -a 256 "$file" > "${file}.sha256"
          fi
        done
        
        echo "âœ… Individual checksum files created"

    - name: Sync artifacts to maven repo and open PR
      if: steps.tag_version.outputs.is_manual != 'true'
      id: sync_maven_repo
      env:
        ARTIFACT_REPO_TOKEN: ${{ secrets.ARTIFACT_REPO_TOKEN }}
      run: |
        set -euo pipefail

        VERSION="${{ steps.tag_version.outputs.version }}"
        TAG_NAME="${{ steps.tag_version.outputs.tag_name }}"

        if [[ -z "${ARTIFACT_REPO_TOKEN:-}" ]]; then
          echo "âŒ Missing secret: ARTIFACT_REPO_TOKEN (repo:write to android-gpuimage-plus-maven)"
          exit 1
        fi

        ARTIFACT_REPO="wysaid/android-gpuimage-plus-maven"
        WORKDIR="/tmp/maven-repo-target"
        SOURCE_REPO="/tmp/maven-repo"
        BRANCH="sync/v${VERSION}"

        echo "ðŸ”„ Cloning artifact repo..."
        git clone --depth 1 "https://${ARTIFACT_REPO_TOKEN}@github.com/${ARTIFACT_REPO}.git" "$WORKDIR"

        echo "ðŸšš Syncing generated Maven artifacts..."
        mkdir -p "$WORKDIR/org/wysaid/gpuimage-plus"
        rsync -av --delete "${SOURCE_REPO}/org/wysaid/gpuimage-plus/" "$WORKDIR/org/wysaid/gpuimage-plus/"

        echo "ðŸ§­ Regenerating index pages"
        pushd "$WORKDIR"
        chmod +x genSites.sh
        ./genSites.sh

        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git checkout -b "$BRANCH"
        git add org/wysaid/gpuimage-plus || true

        echo "artifact_pr_url=" >> $GITHUB_OUTPUT

        if git diff --cached --quiet; then
          echo "â„¹ï¸ No changes to publish; skipping PR."
          exit 0
        fi

        git commit -m "Publish artifacts ${TAG_NAME}"
        git push origin "$BRANCH"

        echo "ðŸ“ Creating pull request..."
        PR_BODY=$(printf "Automated artifact sync for %s.\n\nGenerated by main repo release workflow." "$TAG_NAME")
        API_JSON=$(jq -n --arg title "Publish ${TAG_NAME} artifacts" \
                        --arg head "$BRANCH" \
                        --arg base "master" \
                        --arg body "$PR_BODY" \
                        '{title:$title, head:$head, base:$base, body:$body}')

        PR_RESPONSE=$(curl -sS -X POST \
          -H "Authorization: token ${ARTIFACT_REPO_TOKEN}" \
          -H "Accept: application/vnd.github+json" \
          -d "$API_JSON" \
          "https://api.github.com/repos/${ARTIFACT_REPO}/pulls")

        echo "PR response: $PR_RESPONSE"
        PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')
        if [[ "$PR_URL" == "null" || -z "$PR_URL" ]]; then
          echo "âŒ Failed to create PR"
          exit 1
        fi

        echo "âœ… PR created: $PR_URL"
        echo "artifact_pr_url=$PR_URL" >> $GITHUB_OUTPUT
        popd
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ steps.tag_version.outputs.version }}"
        TAG_NAME="${{ steps.tag_version.outputs.tag_name }}"
        cat > /tmp/release_notes.md << EOF
        ## ðŸš€ Android GPUImage Plus $TAG_NAME
        
        ### ðŸ“¦ Downloads
        
        **Demo APK:**
        - \`cgeDemo-$VERSION.apk\` - Demo application with full video features
        
        **AAR Library Artifacts:**
        
        Four variants are available for different use cases:
        
        1. **gpuimage-plus-$VERSION.aar**
           - Page size: 4KB (default)
           - Full-featured with FFmpeg bundled
           - Architectures: armeabi-v7a, arm64-v8a, x86, x86_64
        
        2. **gpuimage-plus-$VERSION-16k.aar**
           - Page size: 16KB
           - Full-featured with FFmpeg bundled
           - Architectures: armeabi-v7a, arm64-v8a, x86, x86_64
        
        3. **gpuimage-plus-$VERSION-min.aar**
           - Page size: 4KB (default)
           - Image-only version (no video features or FFmpeg)
           - Architectures: armeabi-v7a, arm64-v8a, x86, x86_64
        
        4. **gpuimage-plus-$VERSION-16k-min.aar**
           - Page size: 16KB
           - Image-only version (no video features or FFmpeg)
           - Architectures: armeabi-v7a, arm64-v8a, x86, x86_64
        
        ### ðŸ”§ Gradle Dependency
        
        \`\`\`gradle
        allprojects {
            repositories {
                maven {
                    url 'https://maven.wysaid.org/'
                }
            }
        }
        
        dependencies {
            // Choose one of the following based on your needs:
            
            // Full-featured with FFmpeg (4KB page size)
            implementation 'org.wysaid:gpuimage-plus:$VERSION'
            
            // Full-featured with FFmpeg (16KB page size)
            implementation 'org.wysaid:gpuimage-plus:$VERSION-16k'
            
            // Image-only, no video (4KB page size)
            implementation 'org.wysaid:gpuimage-plus:$VERSION-min'
            
            // Image-only, no video (16KB page size)
            implementation 'org.wysaid:gpuimage-plus:$VERSION-16k-min'
        }
        \`\`\`
        
        ### ðŸ“‹ System Requirements
        
        - **Minimum Android SDK**: API 21 (Android 5.0)
        - **Target Android SDK**: API 25
        - **NDK Version**: r26d
        - **Supported Architectures**: armeabi-v7a, arm64-v8a, x86, x86_64
        
        ### ðŸ“š Documentation
        
        - **GitHub Repository**: https://github.com/wysaid/android-gpuimage-plus
        - **Build & Integration Guide**: https://github.com/wysaid/android-gpuimage-plus/blob/master/docs/build.md
        - **Filter Rule Documentation**: https://github.com/wysaid/android-gpuimage-plus/blob/master/docs/filter-rules.md
        
        ---
        
        For complete changelog, see the auto-generated content below.
        EOF
        
        echo "âœ… Release notes generated"
    
    - name: Create GitHub Release
      if: steps.tag_version.outputs.is_manual != 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag_version.outputs.tag_name }}
        name: Release ${{ steps.tag_version.outputs.tag_name }}
        body_path: /tmp/release_notes.md
        files: |
          /tmp/release-artifacts/*.apk
          /tmp/release-artifacts/*.aar
          /tmp/release-artifacts/SHA256SUMS.txt
          /tmp/release-artifacts/*.sha256
        draft: false
        prerelease: ${{ steps.tag_version.outputs.is_prerelease == 'true' }}
        generate_release_notes: true
        make_latest: ${{ steps.tag_version.outputs.is_prerelease != 'true' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts (Manual trigger)
      if: steps.tag_version.outputs.is_manual == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-${{ steps.tag_version.outputs.version }}
        path: /tmp/release-artifacts/
        retention-days: 7
    
    - name: Manual trigger success message
      if: steps.tag_version.outputs.is_manual == 'true'
      run: |
        echo "ðŸŽ‰ ============================================" 
        echo "ðŸŽ‰ Manual build completed successfully!"
        echo "ðŸŽ‰ ============================================"
        echo ""
        echo "ðŸ“¦ Version: ${{ steps.tag_version.outputs.version }}"
        echo "ðŸ“¦ Artifacts are available for download from the workflow run."
        echo ""
        echo "âš ï¸  Note: This is a manual trigger build."
        echo "âš ï¸  Artifacts are NOT published to the Release page."
        echo "âš ï¸  To create an official release, push a tag (e.g., git tag v${{ steps.tag_version.outputs.version }} && git push origin v${{ steps.tag_version.outputs.version }})"
        echo ""
        echo "ðŸ“¦ Built artifacts:"
        ls -lh /tmp/release-artifacts/
    
    - name: Summary
      run: |
        IS_MANUAL="${{ steps.tag_version.outputs.is_manual }}"
        VERSION="${{ steps.tag_version.outputs.version }}"
        TAG_NAME="${{ steps.tag_version.outputs.tag_name }}"
        
        if [ "$IS_MANUAL" = "true" ]; then
          echo "## ðŸ”§ Manual Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: Manual (workflow_dispatch)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Note" >> $GITHUB_STEP_SUMMARY
          echo "This is a **manual trigger build**. Artifacts are **NOT published** to the Release page." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To create an official release, push a tag:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git tag v$VERSION && git push origin v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Built Artifacts (available for download):" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release**: $TAG_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Version Validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tag format validated: v\${major}.\${minor}.\${patch}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version matches project version in build.gradle" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Released Artifacts:" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "**Demo APK:**" >> $GITHUB_STEP_SUMMARY
        echo "- cgeDemo-$VERSION.apk" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**AAR Libraries:**" >> $GITHUB_STEP_SUMMARY
        echo "- gpuimage-plus-$VERSION.aar (4KB, with video)" >> $GITHUB_STEP_SUMMARY
        echo "- gpuimage-plus-$VERSION-16k.aar (16KB, with video)" >> $GITHUB_STEP_SUMMARY
        echo "- gpuimage-plus-$VERSION-min.aar (4KB, image-only)" >> $GITHUB_STEP_SUMMARY
        echo "- gpuimage-plus-$VERSION-16k-min.aar (16KB, image-only)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$IS_MANUAL" != "true" ]; then
          echo "Release page: ${{ github.server_url }}/${{ github.repository }}/releases/tag/$TAG_NAME" >> $GITHUB_STEP_SUMMARY
        fi

        ARTIFACT_PR_URL="${{ steps.sync_maven_repo.outputs.artifact_pr_url }}"
        if [ -n "$ARTIFACT_PR_URL" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“® Artifact Repository PR" >> $GITHUB_STEP_SUMMARY
          echo "- $ARTIFACT_PR_URL" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Add build time if available
        BUILD_TIME="${{ steps.build_variants.outputs.build_time }}"
        if [ -n "$BUILD_TIME" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Build Performance" >> $GITHUB_STEP_SUMMARY
          echo "- Total build time: $((BUILD_TIME / 60)) minutes $((BUILD_TIME % 60)) seconds" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Build failure notification
      if: failure()
      run: |
        echo "::error::Release build failed for version ${{ steps.tag_version.outputs.version }}"
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ steps.tag_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tag**: ${{ steps.tag_version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Common Issues" >> $GITHUB_STEP_SUMMARY
        echo "- Version mismatch between tag and build.gradle" >> $GITHUB_STEP_SUMMARY
        echo "- NDK/CMake configuration issues" >> $GITHUB_STEP_SUMMARY
        echo "- Missing dependencies or build tools" >> $GITHUB_STEP_SUMMARY
        echo "- Network issues during artifact sync" >> $GITHUB_STEP_SUMMARY
